---
title: "simulation"
author: "He Junhui"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(devtools)
library(microbenchmark)
library(parallel)
library(Matrix)
library(RSpectra)
library(ggplot2)
library(Rcpp)
library(RcppEigen)
```

```{r}
Sys.setlocale("LC_ALL","English")
```

```{r}
n = 2400
d = 2
s = 600
r = 3
m = 100
t = 1
X = matrix(rnorm(n*d), n, d)
```

```{r}
cl = makeCluster(8)
microbenchmark({
  U = subsample(X, s, method = "kmeans")
  Z = cross_similarity(X, U, r, cl=cl)
  eigenpairs = truncated_SVD(Z)
},
times = 10)
stopCluster(cl)
```

```{r}
cl = makeCluster(8)
microbenchmark({
  heat_kernel_covariance(X, s, r, m, t, cl=cl)
},
times = 10)
stopCluster(cl)
```

```{r}
x = c(1:1e2)
```

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;
// [[Rcpp::export]]

void test_loop(int n, const Rcpp::NumericVector& x ) {
  for(int i=0;i<n;i++){
    x*x;
}
}

```

```{r}
microbenchmark({lapply(c(1:1e3), function(i) {for(j in 1:10) {x*x}})},
               {lapply(c(1:1e4), function(i) {x*x})},
               {for(i in c(1:1e4)) {x*x}},
               {test_loop(1e4, x)},
               times = 10)
```



+ test pgbinary


```{r}
X0 <- matrix(rnorm(50*3), 50, 3)
X1 <- matrix(rnorm(50*3, 3), 50, 3)
Y <- c(rep(1,50),rep(0,50))
X <- rbind(X0,X1)
train_ind = sample(50*2)
X <- X[train_ind,]
Y <- Y[train_ind]
X0_new <- matrix(rnorm(50*3),50,3)
X1_new <- matrix(rnorm(50*3, 3),50,3)
X_new <- rbind(X0_new, X1_new)
Y_new <- c(rep(1,50),rep(0,50))
s <- 10; r <- 3
K <- 10
results <- fit_lae_logit_gp(X, Y, X_new, s, r, K, approach = "posterior", output_cov = TRUE)
Y_pred <- results$Y_pred
C <- results$C
Cvv <- as.matrix(C[1:100,])
Cnv <- as.matrix(C[101:200,])
aug_data <- AugmentedData(Cvv, cbind(Y,1-Y))
# Y_pred <- fit_se_logit_gp(X, Y, X_new, s, r, K, approach = "posterior")
error_rate(Y_new, Y_pred)
```

```{r}
Y_pred = test_pgbinary_cpp(Cvv,Y,Cnv)$Y_pred
error_rate(Y_new, Y_pred)
```



```{r}
X0 <- matrix(rnorm(10*3), 10, 3)
X1 <- matrix(rnorm(10*3, 3), 10, 3)
X2 <- matrix(rnorm(10*3, -3), 10, 3)
Y <- c(rep(0,10), rep(1,10), rep(2,10))
X <- rbind(X0,X1,X2)
train_ind = sample(10*3)
X <- X[train_ind,]
Y <- Y[train_ind]
X0_new <- matrix(rnorm(50*3),50,3)
X1_new <- matrix(rnorm(50*3, 3),50,3)
X2_new <- matrix(rnorm(50*3, -3),50,3)
X_new <- rbind(X0_new, X1_new, X2_new)
Y_new <- c(rep(0,50),rep(1,50),rep(2,50))
s <- 10; r <- 3
K <- 10
J <- 3
Y_pred <- fit_lae_logit_mult_gp(X, Y, X_new, J, s, r, K)
# Y_pred <- fit_se_logit_mult_gp(X, Y, X_new, J, s, r, K)
error_rate(Y_new, Y_pred)
```

```{r}
X_total = rbind(X,X_new)
Y_total = c(Y,Y_new)
ggplot() + geom_point(aes(X_total[,1],X_total[,2],col=Y_total))
ggplot() + geom_point(aes(X_new[,1],X_new[,2],col=Y_new)) +
  geom_point(aes(X[,1],X[,2]),col="red")
```

```{r}
X <- matrix(runif(100, -1, 1), 100, 1)
Y <- c(X)^2 + rnorm(100, 0, 0)
X_new <- matrix(runif(200,-1,1),200,1)
Y_new <- c(X_new)^2
s <- 50; r <- 3
K <- 50
Y_pred = fit_lae_reg_gp(X, Y, X_new, s, r, K)
```

```{r}
ggplot() + geom_line(aes(X_new, Y_new), col="red") +
  geom_line(aes(X_new, Y_pred), col="blue") +
  geom_point(aes(X, Y), col="black")
```




```{Rcpp}
//[[Rcpp::depends(RcppEigen)]]
#include <RcppEigen.h>
#include <iostream>
using namespace Rcpp;

//[[Rcpp::export]]
void testeigen() {
  Eigen::MatrixXd A(2,2);
  A << 1,2,
       3,4;
  std::cout << "A:\n" << A << std::endl;
  Eigen::VectorXd v(2);
  v << 1,2;
  std::cout << "A.array().colwise()*v.array():\n" << A.array().colwise()*v.array() << std::endl;
  A.diagonal().array() += 1;
  std::cout << "A:\n" << A << std::endl;
}

//[[Rcpp::export]]
void testdiagonal() {
  Eigen::MatrixXd A = Eigen::MatrixXd::Random(1000,1000);
  Eigen::MatrixXd B = A.diagonal().asDiagonal();
  Eigen::DiagonalMatrix<double,1000> C = A.diagonal().asDiagonal();
  A*C;
}

//[[Rcpp::export]]
void testdiag() {
  Eigen::MatrixXd A = Eigen::MatrixXd::Random(1000,1000);
  Eigen::MatrixXd B = A.diagonal().asDiagonal();
  Eigen::DiagonalMatrix<double,1000> C = A.diagonal().asDiagonal();
  A*A;
}

```

```{Rcpp}
// [[Rcpp::depends(RcppEigen)]]
#include <RcppEigen.h>
#include <iostream>
using namespace Rcpp;

//[[Rcpp::export]]
void testdiagvec() {
  Eigen::MatrixXd A = Eigen::MatrixXd::Random(1000,1000);
  Eigen::MatrixXd B = A.diagonal().asDiagonal();
  Eigen::DiagonalMatrix<double,1000> C = A.diagonal().asDiagonal();
  Eigen::ArrayXd v = A.diagonal();
  A.array().rowwise() *= v.transpose();
}
```

```{Rcpp}
#include <iostream>
//[[Rcpp::depends(RcppEigen)]]
#include <RcppEigen.h>
 
using namespace std;
//[[Rcpp::export]]
void testbc()
{
  Eigen::MatrixXd A = Eigen::MatrixXd::Random(1000,1000);
  Eigen::MatrixXd B = A.diagonal().asDiagonal();
  Eigen::DiagonalMatrix<double,1000> C = A.diagonal().asDiagonal();
  Eigen::ArrayXd v = A.diagonal();
  for(int i=0;i<1000;i++) {
    for(int j=0;j<1000;j++) {
      A(i,j)*v(j);
}
}
}
```



```{r}
microbenchmark({testdiagonal()},
               {testdiag()},
               {testdiagvec()},
               {testbc()},
               {
                 A = matrix(rnorm(1000*1000),1000,1000)
                 A*diag(A)
               },
               times=10)
```

```{Rcpp}
#include <iostream>
//[[Rcpp::depends(RcppEigen)]]
#include <RcppEigen.h>
 
using namespace std;
//[[Rcpp::export]]
void testexp() {
  Eigen::VectorXd v(4);
  v << 1,2,3,4;
  cout << "v is\n" << v << endl;
  Eigen::VectorXd expv = 1/Eigen::exp(v.array());
  cout << "1/exp(v) is\n" << expv << endl;
}
```

```{Rcpp}
#include <iostream>
//[[Rcpp::depends(RcppEigen)]]
#include <RcppEigen.h>
 
using namespace std;
using namespace Eigen;
//[[Rcpp::export]]
void testgreater() {
  Map<VectorXd> vmap = Rcpp::as<Map<VectorXd>>(Rcpp::NumericVector::create(1,2,3,4));
  cout << "vmap is \n" << vmap << endl;
  cout << (vmap.array() + 1e-16) << endl;
}
```


