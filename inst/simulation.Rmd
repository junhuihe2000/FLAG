---
title: "simulation"
author: "He Junhui"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(microbenchmark)
library(parallel)
library(Matrix)
library(RSpectra)
library(ggplot2)
```

```{r}
Sys.setlocale("LC_ALL","English")
```

```{r}
n = 2400
d = 2
s = 600
r = 3
m = 100
t = 1
X = matrix(rnorm(n*d), n, d)
```

```{r}
cl = makeCluster(8)
microbenchmark({
  U = subsample(X, s, method = "kmeans")
  Z = cross_similarity(X, U, r, cl=cl)
  eigenpairs = truncated_SVD(Z)
},
times = 10)
stopCluster(cl)
```

```{r}
cl = makeCluster(8)
microbenchmark({
  heat_kernel_covariance(X, s, r, m, t, cl=cl)
},
times = 10)
stopCluster(cl)
```

```{r}
x = c(1:1e2)
```

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;
// [[Rcpp::export]]

void test_loop(int n, const Rcpp::NumericVector& x ) {
  for(int i=0;i<n;i++){
    x*x;
}
}

```

```{r}
microbenchmark({lapply(c(1:1e3), function(i) {for(j in 1:10) {x*x}})},
               {lapply(c(1:1e4), function(i) {x*x})},
               {for(i in c(1:1e4)) {x*x}},
               {test_loop(1e4, x)},
               times = 10)
```

```{r}
s = list("cov"=1,"name"="mickey")
class(s) = "mouth"
```

```{r}
A <- matrix(rnorm(3*3),3,3)
C <- A%*%t(A)
Y <- matrix(sample.int(9,replace = TRUE),3,3)
SBMultinomialGP(C,Y)
```

```{Rcpp}
#include <Rcpp.h>
#include <iostream>
using namespace Rcpp;
//[[Rcpp::export]]
void add(int &x, int y) {
  x = x + y;
  std::cout << x << std::endl;
}

//[[Rcpp::export]]
void add2(int &x, int y) {
  add(x, y);
  x = x + y;
  std::cout << x << std::endl;
}
```

```{r}
add_r <- function(x, y) {
  x = x + y
}
```

```{r}
a = 1; b = 1
c = 1
add(a,c)
add_r(b,c)
print(a)
print(b)
```

```{r}
add(a,c)
add2(a,c)
```

```{r}
i = 0
repeat{
  if(i>2) {break}
  i = i + 1
  cat("i =",i,"\n")
}
```

```{r}
Y_pred = vapply(res$f, function(x){
  if(x>0){
  return(1)
    } else {
      return(0)
      }
  }, FUN.VALUE = 0)
```

```{r}
X0 <- matrix(rnorm(20*3), 20, 3)
X1 <- matrix(rnorm(20*3, 3), 20, 3)
Y <- c(rep(1,20),rep(0,20))
X <- rbind(X0,X1)
X0_new <- matrix(rnorm(50*3),50,3)
X1_new <- matrix(rnorm(50*3, 3),50,3)
X_new <- rbind(X0_new, X1_new)
Y_new <- c(rep(1,50),rep(0,50))
s <- 10; r <- 3
K <- 10
Y_pred <- fit_lae_logit_gp(X, Y, X_new, s, r, K, approach = "posterior")
error_rate(Y_new, Y_pred)
```

```{r}
X0 <- matrix(rnorm(3*3), 3, 3)
X1 <- matrix(rnorm(3*3, 5), 3, 3)
X2 <- matrix(rnorm(3*3, -5), 3, 3)
Y <- c(0,0,0,1,1,1,2,2,2)
X <- rbind(X0,X1,X2)
X0_new <- matrix(rnorm(10*3),10,3)
X1_new <- matrix(rnorm(10*3, 5),10,3)
X2_new <- matrix(rnorm(10*3, -5),10,3)
X_new <- rbind(X0_new, X1_new, X2_new)
s <- 6; r <- 3
m <- 6; K <- 3
J <- 3
eigenpair <- heat_kernel_spectrum(X, X_new, s, r, K=K)
train_lae_logit_mult_gp(eigenpair, Y, K, J)
```

```{r}
X0 <- matrix(rnorm(10*3), 10, 3)
X1 <- matrix(rnorm(10*3, 3), 10, 3)
X2 <- matrix(rnorm(10*3, -3), 10, 3)
Y <- c(rep(0,10), rep(1,10), rep(2,10))
X <- rbind(X0,X1,X2)
X0_new <- matrix(rnorm(50*3),50,3)
X1_new <- matrix(rnorm(50*3, 3),50,3)
X2_new <- matrix(rnorm(50*3, -3),50,3)
X_new <- rbind(X0_new, X1_new, X2_new)
Y_new <- c(rep(0,50),rep(1,50),rep(2,50))
s <- 10; r <- 3
K <- 10
J <- 3
Y_pred <- fit_lae_logit_mult_gp(X, Y, X_new, J, s, r, K)
error_rate(Y_new, Y_pred)
```

```{r}
X_total = rbind(X,X_new)
Y_total = c(Y,Y_new)
ggplot() + geom_point(aes(X_total[,1],X_total[,2],col=Y_total))
ggplot() + geom_point(aes(X_new[,1],X_new[,2],col=Y_new)) +
  geom_point(aes(X[,1],X[,2]),col="red")
```

